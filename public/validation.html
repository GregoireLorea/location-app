<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Validation Demandes - Gestion des Locations</title>
  <link href="style.css" rel="stylesheet" />
  <style>
    .pending-request {
      border: 2px solid #ffa500;
      background: #fff8e1;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    .request-actions {
      margin-top: 10px;
    }
    .btn-approve { background: #4caf50; color: white; }
    .btn-reject { background: #f44336; color: white; }
    .source-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .source-wpforms { background: #007cba; color: white; }
    .source-email { background: #34a853; color: white; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <h1><a href="index.html" style="color: inherit; text-decoration: none;">Location Manager</a></h1>
    </div>
    <ul class="navbar-nav">
      <li><a href="index.html" class="nav-link">Dashboard</a></li>
      <li><a href="stock.html" class="nav-link">Gestion Stock</a></li>
      <li><a href="locations.html" class="nav-link">Gestion Locations</a></li>
      <li><a href="validation.html" class="nav-link active">Validation Demandes</a></li>
      <li><a href="calendar.html" class="nav-link">Calendrier</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>Validation des Demandes Automatiques</h2>
      <p>Validez les demandes reçues via WordPress ou email</p>
    </div>

    <div class="section">
      <h3>Import CSV (WPForms)</h3>
      <div class="import-section">
        <p>Importez les demandes depuis un export CSV de WPForms</p>
        <input type="file" id="csvFile" accept=".csv" style="margin: 10px 0;">
        <button onclick="importCSV()" class="btn-primary">Importer le CSV</button>
        <div id="importResult" style="margin-top: 10px;"></div>
      </div>
    </div>

    <div class="section">
      <h3>Demandes en attente de validation</h3>
      <div id="pendingRequests">
        <p>Chargement...</p>
      </div>
    </div>

    <div class="section">
      <h3>Historique des validations</h3>
      <div id="validationHistory">
        <p>Chargement...</p>
      </div>
    </div>
  </div>

  <script>
    let locationsData = [];
    let stockData = [];

    async function loadAllData() {
      try {
        const [stockResponse, locationsResponse] = await Promise.all([
          fetch('/stock'),
          fetch('/locations')
        ]);
        
        stockData = await stockResponse.json();
        locationsData = await locationsResponse.json();
        
        displayPendingRequests();
        displayValidationHistory();
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
      }
    }

    function displayPendingRequests() {
      const container = document.getElementById('pendingRequests');
      
      // Filtrer les demandes avec statut 'planned' et source automatique
      const pendingRequests = locationsData.filter(location => 
        location.status === 'planned' && 
        (location.source === 'wpforms' || location.source === 'email')
      );

      if (pendingRequests.length === 0) {
        container.innerHTML = '<p>Aucune demande en attente de validation</p>';
        return;
      }

      container.innerHTML = pendingRequests.map(request => {
        const item = stockData.find(s => s.id === request.itemId);
        const itemName = item ? item.name : `Article ${request.itemId}`;
        
        return `
          <div class="pending-request">
            <div class="request-header">
              <strong>${request.clientName}</strong>
              <span class="source-badge source-${request.source}">${request.source?.toUpperCase()}</span>
              <small style="float: right;">${new Date(request.id).toLocaleString()}</small>
            </div>
            <div class="request-details">
              <p><strong>Contact:</strong> ${request.contactEmail} | ${request.contactPhone}</p>
              <p><strong>Article:</strong> ${itemName} (Qté: ${request.qty})</p>
              <p><strong>Période:</strong> ${request.from} → ${request.to}</p>
              ${request.associationName ? `<p><strong>Association:</strong> ${request.associationName}</p>` : ''}
              ${request.requestComment ? `<p><strong>Commentaire:</strong> ${request.requestComment}</p>` : ''}
            </div>
            <div class="request-actions">
              <button onclick="approveRequest(${request.id})" class="btn-approve">✅ Approuver</button>
              <button onclick="rejectRequest(${request.id})" class="btn-reject">❌ Rejeter</button>
              <button onclick="editRequest(${request.id})" class="btn-edit">✏️ Modifier</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function displayValidationHistory() {
      const container = document.getElementById('validationHistory');
      
      // Afficher les 10 dernières demandes traitées
      const processedRequests = locationsData
        .filter(location => location.source && location.validatedAt)
        .sort((a, b) => new Date(b.validatedAt) - new Date(a.validatedAt))
        .slice(0, 10);

      if (processedRequests.length === 0) {
        container.innerHTML = '<p>Aucun historique de validation</p>';
        return;
      }

      container.innerHTML = `
        <table class="locations-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Source</th>
              <th>Statut</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${processedRequests.map(request => `
              <tr>
                <td>${new Date(request.validatedAt).toLocaleDateString()}</td>
                <td>${request.clientName}</td>
                <td><span class="source-badge source-${request.source}">${request.source?.toUpperCase()}</span></td>
                <td><span class="status-badge status-${request.status}">${request.status}</span></td>
                <td>${request.validationAction || 'Approuvé'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function approveRequest(requestId) {
      try {
        const response = await fetch(`/locations/${requestId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            validatedAt: new Date().toISOString(),
            validationAction: 'Approuvé'
          })
        });

        if (response.ok) {
          alert('Demande approuvée !');
          loadAllData();
        }
      } catch (error) {
        console.error('Erreur lors de l\'approbation:', error);
        alert('Erreur lors de l\'approbation');
      }
    }

    async function rejectRequest(requestId) {
      if (!confirm('Êtes-vous sûr de vouloir rejeter cette demande ?')) return;
      
      try {
        const response = await fetch(`/locations/${requestId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Demande rejetée et supprimée');
          loadAllData();
        }
      } catch (error) {
        console.error('Erreur lors du rejet:', error);
        alert('Erreur lors du rejet');
      }
    }

    function editRequest(requestId) {
      // Rediriger vers la page de locations avec l'ID en paramètre
      window.location.href = `locations.html?edit=${requestId}`;
    }

    async function importCSV() {
      const fileInput = document.getElementById('csvFile');
      const resultDiv = document.getElementById('importResult');
      
      if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<p style="color: red;">Veuillez sélectionner un fichier CSV</p>';
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const csvData = e.target.result;
          
          const response = await fetch('/import/csv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ csvData })
          });
          
          const result = await response.json();
          
          if (result.success) {
            resultDiv.innerHTML = `<p style="color: green;">✅ ${result.imported} demandes importées avec succès!</p>`;
            loadAllData(); // Recharger les données
          } else {
            resultDiv.innerHTML = `<p style="color: red;">❌ Erreur: ${result.error}</p>`;
          }
          
        } catch (error) {
          console.error('Erreur import:', error);
          resultDiv.innerHTML = '<p style="color: red;">❌ Erreur lors de l\'import</p>';
        }
      };
      
      reader.readAsText(file);
    }

    // Actualisation automatique toutes les 30 secondes
    setInterval(loadAllData, 30000);

    // Charger les données au démarrage
    loadAllData();
  </script>
</body>
</html>

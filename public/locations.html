<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Locations - Gestion des Locations</title>
  <link href="style.css" rel="stylesheet" />
  <script src="auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <h1><a href="index.html" style="color: inherit; text-decoration: none;">Location Manager</a></h1>
    </div>
    <ul class="navbar-nav">
      <li><a href="index.html" class="nav-link">Dashboard</a></li>
      <li><a href="stock.html" class="nav-link">Gestion Stock</a></li>
      <li><a href="locations.html" class="nav-link active">Gestion Locations <span id="pendingBadge" class="notification-badge" style="display: none;"></span></a></li>
      <li><a href="calendar.html" class="nav-link">Calendrier</a></li>
      <li><a href="formulaire-location.html" class="nav-link">üìù Demande Public</a></li>
      <li><a href="#" class="nav-link" onclick="logout()" style="color: #e74c3c;">üö™ D√©connexion</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>Gestion des Locations</h2>
      <p>Cr√©ez et g√©rez vos r√©servations de mat√©riel</p>
    </div>

    <div class="section">
      <h3>Nouvelle location</h3>
      <div class="location-form">
        <div class="form-section">
          <h4>Informations client</h4>
          <div class="form-grid">
            <input id="clientLastName" placeholder="Nom du client *" required>
            <input id="clientFirstName" placeholder="Pr√©nom du client *" required>
            <input id="associationName" placeholder="Nom de l'association">
            <input id="contactPhone" placeholder="T√©l√©phone de contact *" type="tel" required>
            <input id="contactEmail" placeholder="Email de contact *" type="email" required>
            <select id="preferredContact" onchange="toggleMessengerField()">
              <option value="">Contact pr√©f√©r√© *</option>
              <option value="email">Email</option>
              <option value="phone">T√©l√©phone</option>
              <option value="messenger">Messenger</option>
            </select>
            <input id="messengerHandle" placeholder="Contact Messenger" style="display: none;">
          </div>
        </div>

        <div class="form-section">
          <h4>D√©tails de la location</h4>
          <div class="form-grid">
            <input id="fromDate" type="date" required>
            <input id="fromTime" type="time" placeholder="Heure de d√©but">
            <input id="toDate" type="date" required>
            <input id="toTime" type="time" placeholder="Heure de fin">
            <textarea id="requestComment" placeholder="Commentaire sur la demande" rows="3"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h4>Mat√©riel √† louer</h4>
          <div id="materialSelection">
            <div class="material-item">
              <select class="material-select" onchange="updateMaterialPrice(this)">
                <option value="">S√©lectionner un article</option>
              </select>
              <input type="number" class="material-qty" placeholder="Qt√©" min="1" value="1">
              <span class="material-price">0‚Ç¨/jour</span>
              <button type="button" onclick="removeMaterialItem(this)" class="btn-remove">√ó</button>
            </div>
          </div>
          <button type="button" onclick="addMaterialItem()" class="btn-secondary">Ajouter un article</button>
        </div>

        <div class="form-section">
          <h4>R√©capitulatif</h4>
          <div class="booking-summary">
            <div id="summaryDetails">
              <p>S√©lectionnez du mat√©riel pour voir le r√©capitulatif</p>
            </div>
            <div class="total-cost">
              <strong>Total: <span id="totalCost">0‚Ç¨</span></strong>
            </div>
          </div>
          <button onclick="createLocation()" class="btn-primary">Confirmer la r√©servation</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Filtres et recherche</h3>
      <div class="filter-bar">
        <input id="searchLocations" placeholder="Rechercher client, article..." onkeyup="filterLocations()">
        <select id="statusFilter" onchange="filterLocations()">
          <option value="">Tous les statuts</option>
          <option value="pending">En attente</option>
          <option value="approved">Approuv√©es</option>
          <option value="rejected">Refus√©es</option>
        </select>
        <input id="dateFilter" type="date" onchange="filterLocations()" title="Filtrer par date">
      </div>
    </div>

    <!-- Sections d'√©tat des locations -->
    <div class="section">
      <h3>üïí Demandes en attente de validation</h3>
      <div class="pending-list" id="pendingLocations">
        <p>Chargement...</p>
      </div>
    </div>

    <div class="section">
      <h3>üìÖ Locations approuv√©es</h3>
      <div class="planned-list" id="plannedLocations">
        <p>Chargement...</p>
      </div>
    </div>

    <div class="section">
      <h3>R√©servations</h3>
      <div class="locations-table-container">
        <table class="locations-table" id="locationsTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>Contact</th>
              <th>Mat√©riel</th>
              <th>Dates</th>
              <th>Dur√©e</th>
              <th>Total</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="locationsTableBody">
            <tr>
              <td colspan="8">Chargement...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal d'√©dition de location -->
  <div id="editLocationModal" class="modal">
    <div class="modal-content modal-large">
      <span class="close" onclick="closeEditLocationModal()">&times;</span>
      <h3>Modifier la r√©servation</h3>
      <div class="location-form">
        <div class="form-section">
          <h4>Informations client</h4>
          <div class="form-grid">
            <input id="editClientLastName" placeholder="Nom du client">
            <input id="editClientFirstName" placeholder="Pr√©nom du client">
            <input id="editAssociationName" placeholder="Nom de l'association">
            <input id="editContactPhone" placeholder="T√©l√©phone de contact" type="tel">
            <input id="editContactEmail" placeholder="Email de contact" type="email">
            <select id="editPreferredContact" onchange="toggleEditMessengerField()">
              <option value="">Contact pr√©f√©r√©</option>
              <option value="email">Email</option>
              <option value="phone">T√©l√©phone</option>
              <option value="messenger">Messenger</option>
            </select>
            <input id="editMessengerHandle" placeholder="Contact Messenger" style="display: none;">
          </div>
        </div>

        <div class="form-section">
          <h4>D√©tails de la location</h4>
          <div class="form-grid">
            <input id="editFromDate" type="date">
            <input id="editFromTime" type="time">
            <input id="editToDate" type="date">
            <input id="editToTime" type="time">
            <textarea id="editRequestComment" placeholder="Commentaire sur la demande" rows="3"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h4>Mat√©riel</h4>
          <div id="editMaterialSelection">
            <!-- Sera rempli dynamiquement -->
          </div>
          <button type="button" onclick="addEditMaterialItem()" class="btn-secondary">Ajouter un article</button>
        </div>

        <div class="form-actions">
          <button onclick="updateLocation()" class="btn-primary">Mettre √† jour</button>
          <button onclick="closeEditLocationModal()" class="btn-secondary">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let stockData = [];
    let locationsData = [];
    let editingLocationId = null;

    async function loadAllData() {
      console.log('Chargement des donn√©es...');
      try {
        const [stockResponse, locationsResponse] = await Promise.all([
          fetch('/stock'),
          fetch('/locations')
        ]);
        
        console.log('R√©ponses re√ßues:', stockResponse.status, locationsResponse.status);
        
        stockData = await stockResponse.json();
        locationsData = await locationsResponse.json();
        
        console.log('Donn√©es charg√©es:', { stockData, locationsData });
        
        populateMaterialSelects();
        refreshLocationsTable();
        updateSummary();
        updatePendingAndPlanned();
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
      }
    }

    function populateMaterialSelects() {
      const selects = document.querySelectorAll('.material-select');
      const options = stockData.map(item => 
        `<option value="${item.id}" data-price="${item.price || 0}">${item.name} (${item.price || 0}‚Ç¨/jour)</option>`
      ).join('');

      selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">S√©lectionner un article</option>' + options;
        if (currentValue) select.value = currentValue;
      });
    }

    function addMaterialItem() {
      const container = document.getElementById('materialSelection');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'material-item';
      itemDiv.innerHTML = `
        <select class="material-select" onchange="updateMaterialPrice(this)">
          <option value="">S√©lectionner un article</option>
          ${stockData.map(item => 
            `<option value="${item.id}" data-price="${item.price || 0}">${item.name} (${item.price || 0}‚Ç¨/jour)</option>`
          ).join('')}
        </select>
        <input type="number" class="material-qty" placeholder="Qt√©" min="1" value="1" onchange="updateSummary()">
        <span class="material-price">0‚Ç¨/jour</span>
        <button type="button" onclick="removeMaterialItem(this)" class="btn-remove">√ó</button>
      `;
      container.appendChild(itemDiv);
    }

    function removeMaterialItem(button) {
      button.parentElement.remove();
      updateSummary();
    }

    function updateMaterialPrice(select) {
      const priceSpan = select.parentElement.querySelector('.material-price');
      const selectedOption = select.options[select.selectedIndex];
      const price = selectedOption.dataset.price || 0;
      priceSpan.textContent = price + '‚Ç¨/jour';
      updateSummary();
    }

    function updateSummary() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      
      if (!fromDate || !toDate) {
        document.getElementById('summaryDetails').innerHTML = '<p>S√©lectionnez des dates pour voir le r√©capitulatif</p>';
        document.getElementById('totalCost').textContent = '0‚Ç¨';
        return;
      }

      const days = Math.round((new Date(toDate) - new Date(fromDate)) / (1000 * 60 * 60 * 24)) + 1;
      
      const materials = [];
      let totalCost = 0;

      document.querySelectorAll('.material-item').forEach(item => {
        const select = item.querySelector('.material-select');
        const qtyInput = item.querySelector('.material-qty');
        
        if (select.value && qtyInput.value) {
          const selectedOption = select.options[select.selectedIndex];
          const price = parseFloat(selectedOption.dataset.price) || 0;
          const qty = parseInt(qtyInput.value) || 1;
          const itemCost = price * qty * days;
          
          materials.push({
            name: selectedOption.text.split(' (')[0],
            qty: qty,
            pricePerDay: price,
            totalCost: itemCost
          });
          
          totalCost += itemCost;
        }
      });

      let summaryHTML = `<p><strong>Dur√©e:</strong> ${days} jour(s)</p>`;
      if (materials.length > 0) {
        summaryHTML += '<ul>';
        materials.forEach(mat => {
          summaryHTML += `<li>${mat.name} x${mat.qty} - ${mat.totalCost.toFixed(2)}‚Ç¨</li>`;
        });
        summaryHTML += '</ul>';
      }

      document.getElementById('summaryDetails').innerHTML = summaryHTML;
      document.getElementById('totalCost').textContent = totalCost.toFixed(2) + '‚Ç¨';
    }

    async function createLocation() {
      const clientLastName = document.getElementById('clientLastName').value;
      const clientFirstName = document.getElementById('clientFirstName').value;
      const associationName = document.getElementById('associationName').value;
      const contactPhone = document.getElementById('contactPhone').value;
      const contactEmail = document.getElementById('contactEmail').value;
      const preferredContact = document.getElementById('preferredContact').value;
      const messengerHandle = document.getElementById('messengerHandle').value;
      const fromDate = document.getElementById('fromDate').value;
      const fromTime = document.getElementById('fromTime').value;
      const toDate = document.getElementById('toDate').value;
      const toTime = document.getElementById('toTime').value;
      const requestComment = document.getElementById('requestComment').value;

      if (!clientLastName || !clientFirstName || !contactPhone || !contactEmail || !preferredContact || !fromDate || !toDate) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }

      // Combiner nom et pr√©nom pour cr√©er le nom complet
      const clientName = `${clientFirstName} ${clientLastName}`;

      // Collecter le mat√©riel s√©lectionn√©
      const materials = [];
      document.querySelectorAll('.material-item').forEach(item => {
        const select = item.querySelector('.material-select');
        const qtyInput = item.querySelector('.material-qty');
        
        if (select.value && qtyInput.value) {
          materials.push({
            itemId: parseInt(select.value),
            qty: parseInt(qtyInput.value) || 1
          });
        }
      });

      if (materials.length === 0) {
        alert('Veuillez s√©lectionner au moins un article');
        return;
      }

      try {
        // Pour le moment, cr√©er une location pour chaque article (compatibilit√© avec l'API actuelle)
        for (const material of materials) {
          const response = await fetch('/locations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              clientName,
              clientLastName,
              clientFirstName,
              associationName,
              contactPhone,
              contactEmail,
              preferredContact,
              messengerHandle,
              itemId: material.itemId,
              qty: material.qty,
              from: fromDate,
              fromTime,
              to: toDate,
              toTime,
              requestComment
            })
          });

          if (!response.ok) {
            throw new Error('Erreur lors de la cr√©ation de la r√©servation');
          }
        }

        // R√©initialiser le formulaire
        resetLocationForm();
        loadAllData();
        alert('R√©servation cr√©√©e avec succ√®s !');
      } catch (error) {
        console.error('Erreur lors de la cr√©ation:', error);
        alert('Erreur lors de la cr√©ation de la r√©servation');
      }
    }

    function resetLocationForm() {
      document.getElementById('clientLastName').value = '';
      document.getElementById('clientFirstName').value = '';
      document.getElementById('associationName').value = '';
      document.getElementById('contactPhone').value = '';
      document.getElementById('contactEmail').value = '';
      document.getElementById('preferredContact').value = '';
      document.getElementById('messengerHandle').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('fromTime').value = '';
      document.getElementById('toDate').value = '';
      document.getElementById('toTime').value = '';
      document.getElementById('requestComment').value = '';
      
      // R√©initialiser la visibilit√© du champ Messenger
      toggleMessengerField();
      
      // Garder seulement le premier item de mat√©riel
      const container = document.getElementById('materialSelection');
      const items = container.querySelectorAll('.material-item');
      for (let i = 1; i < items.length; i++) {
        items[i].remove();
      }
      if (items.length > 0) {
        items[0].querySelector('.material-select').value = '';
        items[0].querySelector('.material-qty').value = '1';
        items[0].querySelector('.material-price').textContent = '0‚Ç¨/jour';
      }
      
      updateSummary();
    }

    function refreshLocationsTable() {
      const tbody = document.getElementById('locationsTableBody');
      
      // V√©rifier que les donn√©es sont charg√©es
      if (!locationsData || !stockData) {
        tbody.innerHTML = '<tr><td colspan="8">Chargement...</td></tr>';
        return;
      }
      
      if (locationsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">Aucune r√©servation</td></tr>';
        return;
      }

      tbody.innerHTML = locationsData.map(location => {
        const item = stockData.find(s => s.id === location.itemId);
        const itemName = item ? item.name : `Article ${location.itemId}`;
        
        const fromDate = new Date(location.from);
        const toDate = new Date(location.to);
        
        let status = 'rejected';
        let statusText = 'Rejet√©e';

        // Utiliser le statut r√©el de la location
        if (location.status === 'pending') {
          status = 'pending';
          statusText = 'En attente';
        } else if (location.status === 'approved') {
          status = 'approved';
          statusText = 'Approuv√©e';
        } else if (location.status === 'rejected') {
          status = 'rejected';
          statusText = 'Rejet√©e';
        }

        const days = Math.round((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
        const price = item ? item.price || 0 : 0;
        const total = price * (location.qty || 1) * days;

        const contactInfo = [
          location.contactPhone && `üìû ${location.contactPhone}`,
          location.contactEmail && `‚úâÔ∏è ${location.contactEmail}`,
          location.messengerHandle && `üí¨ ${location.messengerHandle}`
        ].filter(Boolean).join('<br>');

        return `
          <tr class="status-${status}">
            <td>
              <strong>${location.clientName}</strong>
              ${location.associationName ? `<br><small>${location.associationName}</small>` : ''}
            </td>
            <td>
              ${contactInfo || 'Non renseign√©'}
              ${location.preferredContact ? `<br><small>Pr√©f√®re: ${location.preferredContact}</small>` : ''}
            </td>
            <td>
              ${itemName}
              <br><small>Qt√©: ${location.qty || 1}</small>
            </td>
            <td>
              ${location.from}${location.fromTime ? ` ${location.fromTime}` : ''}<br>‚Üí ${location.to}${location.toTime ? ` ${location.toTime}` : ''}
            </td>
            <td>${days} jour(s)</td>
            <td>${total.toFixed(2)}‚Ç¨</td>
            <td><span class="status-badge status-${status}">${statusText}</span></td>
            <td class="actions">
              <button onclick="editLocation(${location.id})" class="btn-edit">Modifier</button>
              <button onclick="deleteLocation(${location.id})" class="btn-delete">Supprimer</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterLocations() {
      const search = document.getElementById('searchLocations').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      let filtered = locationsData.filter(location => {
        const item = stockData.find(s => s.id === location.itemId);
        const itemName = item ? item.name : `Article ${location.itemId}`;
        
        const matchSearch = !search || 
          location.clientName.toLowerCase().includes(search) ||
          itemName.toLowerCase().includes(search) ||
          (location.associationName && location.associationName.toLowerCase().includes(search)) ||
          (location.requestComment && location.requestComment.toLowerCase().includes(search));
        
        let matchStatus = true;
        if (status) {
          switch (status) {
            case 'pending':
              matchStatus = location.status === 'pending';
              break;
            case 'approved':
              matchStatus = location.status === 'approved';
              break;
            case 'rejected':
              matchStatus = location.status === 'rejected';
              break;
          }
        }

        const matchDate = !dateFilter || 
          location.from <= dateFilter && location.to >= dateFilter;

        return matchSearch && matchStatus && matchDate;
      });

      // Temporairement remplacer locationsData pour l'affichage
      const originalData = locationsData;
      locationsData = filtered;
      refreshLocationsTable();
      locationsData = originalData;
    }

    function editLocation(id) {
      const location = locationsData.find(l => l.id === id);
      if (!location) return;

      editingLocationId = id;
      
      document.getElementById('editClientLastName').value = location.clientLastName || '';
      document.getElementById('editClientFirstName').value = location.clientFirstName || '';
      document.getElementById('editAssociationName').value = location.associationName || '';
      document.getElementById('editContactPhone').value = location.contactPhone || '';
      document.getElementById('editContactEmail').value = location.contactEmail || '';
      document.getElementById('editPreferredContact').value = location.preferredContact || '';
      document.getElementById('editMessengerHandle').value = location.messengerHandle || '';
      document.getElementById('editFromDate').value = location.from || '';
      document.getElementById('editFromTime').value = location.fromTime || '';
      document.getElementById('editToDate').value = location.to || '';
      document.getElementById('editToTime').value = location.toTime || '';
      document.getElementById('editRequestComment').value = location.requestComment || '';
      
      // Mettre √† jour la visibilit√© du champ Messenger
      toggleEditMessengerField();
      
      // Pour le mat√©riel, on ne peut modifier qu'un seul item pour l'instant
      const editContainer = document.getElementById('editMaterialSelection');
      editContainer.innerHTML = `
        <div class="material-item">
          <select class="material-select">
            <option value="">S√©lectionner un article</option>
            ${stockData.map(item => 
              `<option value="${item.id}" ${item.id === location.itemId ? 'selected' : ''} data-price="${item.price || 0}">
                ${item.name} (${item.price || 0}‚Ç¨/jour)
              </option>`
            ).join('')}
          </select>
          <input type="number" class="material-qty" placeholder="Qt√©" min="1" value="${location.qty || 1}">
          <span class="material-price">${stockData.find(s => s.id === location.itemId)?.price || 0}‚Ç¨/jour</span>
        </div>
      `;
      
      document.getElementById('editLocationModal').style.display = 'block';
    }

    function closeEditLocationModal() {
      document.getElementById('editLocationModal').style.display = 'none';
      editingLocationId = null;
    }

    async function updateLocation() {
      if (!editingLocationId) return;

      const clientLastName = document.getElementById('editClientLastName').value;
      const clientFirstName = document.getElementById('editClientFirstName').value;
      const associationName = document.getElementById('editAssociationName').value;
      const contactPhone = document.getElementById('editContactPhone').value;
      const contactEmail = document.getElementById('editContactEmail').value;
      const preferredContact = document.getElementById('editPreferredContact').value;
      const messengerHandle = document.getElementById('editMessengerHandle').value;
      const fromDate = document.getElementById('editFromDate').value;
      const fromTime = document.getElementById('editFromTime').value;
      const toDate = document.getElementById('editToDate').value;
      const toTime = document.getElementById('editToTime').value;
      const requestComment = document.getElementById('editRequestComment').value;

      const materialSelect = document.querySelector('#editMaterialSelection .material-select');
      const materialQty = document.querySelector('#editMaterialSelection .material-qty');
      const itemId = parseInt(materialSelect.value);
      const qty = parseInt(materialQty.value) || 1;

      // Combiner nom et pr√©nom
      const clientName = `${clientFirstName} ${clientLastName}`;

      try {
        const response = await fetch(`/locations/${editingLocationId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            clientName,
            clientLastName,
            clientFirstName,
            associationName,
            contactPhone,
            contactEmail,
            preferredContact,
            messengerHandle,
            itemId,
            qty,
            from: fromDate,
            fromTime,
            to: toDate,
            toTime,
            requestComment
          })
        });

        if (response.ok) {
          closeEditLocationModal();
          loadAllData();
        }
      } catch (error) {
        console.error('Erreur lors de la mise √† jour:', error);
      }
    }

    async function deleteLocation(id) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©servation ?')) return;

      try {
        const response = await fetch(`/locations/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (response.ok) {
          loadAllData();
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
      }
    }

    function toggleMessengerField() {
      const preferredContact = document.getElementById('preferredContact').value;
      const messengerField = document.getElementById('messengerHandle');
      messengerField.style.display = preferredContact === 'messenger' ? 'block' : 'none';
      if (preferredContact !== 'messenger') {
        messengerField.value = '';
      }
    }

    function toggleEditMessengerField() {
      const preferredContact = document.getElementById('editPreferredContact').value;
      const messengerField = document.getElementById('editMessengerHandle');
      messengerField.style.display = preferredContact === 'messenger' ? 'block' : 'none';
      if (preferredContact !== 'messenger') {
        messengerField.value = '';
      }
    }

    // G√©rer l'affichage du champ Messenger
    const preferredContactElement = document.getElementById('preferredContact');
    if (preferredContactElement) {
      preferredContactElement.addEventListener('change', function() {
        const messengerField = document.getElementById('messengerHandle');
        if (messengerField) {
          messengerField.style.display = this.value === 'messenger' ? 'block' : 'none';
        }
      });
    }

    // G√©rer les changements de dates pour le r√©capitulatif
    const fromDateElement = document.getElementById('fromDate');
    const toDateElement = document.getElementById('toDate');
    
    if (fromDateElement) {
      fromDateElement.addEventListener('change', updateSummary);
    }
    if (toDateElement) {
      toDateElement.addEventListener('change', updateSummary);
    }

    // Fermer les modales en cliquant √† l'ext√©rieur
    window.onclick = function(event) {
      const editModal = document.getElementById('editLocationModal');

      if (event.target == editModal) {
        closeEditLocationModal();
      }
    }

    function addEditMaterialItem() {
      const container = document.getElementById('editMaterialSelection');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'material-item';
      itemDiv.innerHTML = `
        <select class="material-select">
          <option value="">S√©lectionner un article</option>
          ${stockData.map(item => 
            `<option value="${item.id}" data-price="${item.price || 0}">${item.name} (${item.price || 0}‚Ç¨/jour)</option>`
          ).join('')}
        </select>
        <input type="number" class="material-qty" placeholder="Qt√©" min="1" value="1">
        <span class="material-price">0‚Ç¨/jour</span>
        <button type="button" onclick="removeEditMaterialItem(this)" class="btn-remove">√ó</button>
      `;
      container.appendChild(itemDiv);
    }

    function removeEditMaterialItem(button) {
      button.parentElement.remove();
    }

    function updatePendingAndPlanned() {
      if (!locationsData) return;

      // Filtrer uniquement par statut
      const pending = locationsData.filter(l => l.status === 'pending');
      const planned = locationsData.filter(l => l.status === 'approved');

      // Demandes en attente
      const pendingContainer = document.getElementById('pendingLocations');
      if (pending.length === 0) {
        pendingContainer.innerHTML = '<p>Aucune demande en attente</p>';
      } else {
        pendingContainer.innerHTML = pending.map(l => {
          const stockItem = stockData.find(s => s.id === l.itemId);
          const itemName = stockItem ? stockItem.name : `Article ${l.itemId}`;
          const days = Math.round((new Date(l.to) - new Date(l.from)) / (1000 * 60 * 60 * 24)) + 1;
          const price = stockItem ? stockItem.price || 0 : 0;
          const total = price * (l.qty || 1) * days;
          return `
            <div class="status-item pending-item">
              <div class="item-info">
                <strong>${l.clientName || l.customerName || 'Client inconnu'}</strong>
                <span class="dates">${l.from}${l.fromTime ? ` ${l.fromTime}` : ''} ‚Üí ${l.to}${l.toTime ? ` ${l.toTime}` : ''}</span>
                <span class="details">${itemName} x${l.qty || 1} - ${total.toFixed(2)}‚Ç¨</span>
                ${l.contactEmail || l.customerEmail ? `<span class="email">üìß ${l.contactEmail || l.customerEmail}</span>` : ''}
                ${l.contactPhone || l.customerPhone ? `<span class="phone">üìû ${l.contactPhone || l.customerPhone}</span>` : ''}
                ${l.requestComment || l.comments ? `<div class="comment">üí¨ ${l.requestComment || l.comments}</div>` : ''}
              </div>
              <div class="item-actions">
                <button onclick="approveLocation(${l.id})" class="btn-success" title="Approuver cette demande">
                  ‚úÖ Approuver
                </button>
                <button onclick="rejectLocation(${l.id})" class="btn-danger" title="Refuser cette demande">
                  ‚ùå Refuser
                </button>
                <button onclick="editLocation(${l.id})" class="btn-edit">
                  ‚úèÔ∏è Modifier
                </button>
              </div>
            </div>
          `;
        }).join('');
      }

      // Locations approuv√©es
      const plannedContainer = document.getElementById('plannedLocations');
      if (planned.length === 0) {
        plannedContainer.innerHTML = '<p>Aucune location approuv√©e</p>';
      } else {
        plannedContainer.innerHTML = planned.map(l => {
          const stockItem = stockData.find(s => s.id === l.itemId);
          const itemName = stockItem ? stockItem.name : `Article ${l.itemId}`;
          const days = Math.round((new Date(l.to) - new Date(l.from)) / (1000 * 60 * 60 * 24)) + 1;
          const price = stockItem ? stockItem.price || 0 : 0;
          const total = price * (l.qty || 1) * days;
          return `
            <div class="status-item planned-item">
              <div class="item-info">
                <strong>${l.clientName}</strong>
                <span class="dates">${l.from}${l.fromTime ? ` ${l.fromTime}` : ''} ‚Üí ${l.to}${l.toTime ? ` ${l.toTime}` : ''}</span>
                <span class="material">Article: ${itemName} (Qt√©: ${l.qty || 1}) - ${total.toFixed(2)}‚Ç¨</span>
                ${l.associationName ? `<span class="association">Association: ${l.associationName}</span>` : ''}
                ${l.requestComment ? `<span class="comment">Commentaire: ${l.requestComment}</span>` : ''}
              </div>
              <div class="item-actions">
                <button class="btn-edit" onclick="editLocation(${l.id})">‚úèÔ∏è Modifier</button>
                <button class="btn-danger" onclick="deleteLocation(${l.id})" title="Supprimer cette location">üóëÔ∏è Supprimer</button>
              </div>
            </div>
          `;
        }).join('');
      }
    }


    // Fonctions pour approuver et refuser les demandes
    async function approveLocation(id) {
      if (!confirm('√ätes-vous s√ªr de vouloir approuver cette demande ?')) return;
      try {
        const response = await fetch(`/locations/${id}/approve`, {
          method: 'PUT',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          alert('Demande approuv√©e avec succ√®s ! Un email de confirmation a √©t√© envoy√© au client.');
          loadAllData();
        } else {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          const responseText = await response.text();
          console.log('Response text:', responseText);

          try {
            const error = JSON.parse(responseText);
            alert('Erreur lors de l\'approbation: ' + (error.error || 'Erreur inconnue'));
          } catch (parseError) {
            alert('Erreur lors de l\'approbation: R√©ponse serveur invalide (statut ' + response.status + ')');
          }
        }
      } catch (error) {
        console.error('Erreur lors de l\'approbation:', error);
        alert('Erreur lors de l\'approbation de la demande');
      }
    }

    async function rejectLocation(id) {
      const reason = prompt('Raison du refus (optionnel):');
      if (reason === null) return; // Utilisateur a annul√©

      try {
        const response = await fetch(`/locations/${id}/reject`, {
          method: 'PUT',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reason: reason || '' })
        });

        if (response.ok) {
          alert('Demande refus√©e avec succ√®s ! Un email d\'information a √©t√© envoy√© au client.');
          loadAllData();
        } else {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          const responseText = await response.text();
          console.log('Response text:', responseText);

          try {
            const error = JSON.parse(responseText);
            alert('Erreur lors du refus: ' + (error.error || 'Erreur inconnue'));
          } catch (parseError) {
            alert('Erreur lors du refus: R√©ponse serveur invalide (statut ' + response.status + ')');
          }
        }
      } catch (error) {
        console.error('Erreur lors du refus:', error);
        alert('Erreur lors du refus de la demande');
      }
    }


    // Fonction pour mettre √† jour le badge de notification
    function updatePendingBadge() {
      const pendingCount = locationsData.filter(l => l.status === 'pending').length;
      const badge = document.getElementById('pendingBadge');

      if (pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    // Modifier loadAllData pour inclure la mise √† jour du badge
    const originalLoadAllData = loadAllData;
    loadAllData = function() {
      originalLoadAllData();
      setTimeout(updatePendingBadge, 100); // Petit d√©lai pour s'assurer que les donn√©es sont charg√©es
    };

    // Charger les donn√©es au d√©marrage
    loadAllData();
  </script>
</body>
</html>

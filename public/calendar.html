<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calendrier - Gestion des Locations</title>
  <link href="style.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="auth.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <h1><a href="index.html" style="color: inherit; text-decoration: none;">Location Manager</a></h1>
    </div>
    <ul class="navbar-nav">
      <li><a href="index.html" class="nav-link">Dashboard</a></li>
      <li><a href="stock.html" class="nav-link">Gestion Stock</a></li>
      <li><a href="locations.html" class="nav-link">Gestion Locations</a></li>
      <li><a href="calendar.html" class="nav-link active">Calendrier</a></li>
      <li><a href="formulaire-location.html" class="nav-link">üìù Demande Public</a></li>
      <li><a href="#" class="nav-link" onclick="logout()" style="color: #e74c3c;">üö™ D√©connexion</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>Calendrier des r√©servations</h2>
      <p>Visualisez toutes vos locations dans le temps</p>
    </div>

    <div class="calendar-controls">
      <div class="filter-section">
        <select id="itemFilter">
          <option value="">Tous les articles</option>
        </select>
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="upcoming">√Ä venir</option>
          <option value="active">En cours</option>
          <option value="past">Termin√©es</option>
        </select>
        <button onclick="refreshCalendar()" class="btn-secondary">Actualiser</button>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <span class="legend-color upcoming"></span>
          <span>√Ä venir</span>
        </div>
        <div class="legend-item">
          <span class="legend-color active"></span>
          <span>En cours</span>
        </div>
        <div class="legend-item">
          <span class="legend-color past"></span>
          <span>Termin√©</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div id="calendar"></div>
    </div>

    <div class="section">
      <h3>Planning d√©taill√©</h3>
      <div id="detailedPlanning" class="detailed-planning">
        <p>Chargement du planning...</p>
      </div>
    </div>
  </div>

  <!-- Modal de d√©tail d'√©v√©nement -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEventModal()">&times;</span>
      <div id="eventDetails">
        <!-- Sera rempli dynamiquement -->
      </div>
    </div>
  </div>

  <!-- Chargement de FullCalendar √† la fin pour √©viter les conflits -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    console.log("Script JavaScript charg√© !");
    let globalCalendar = null;
    let stockData = [];
    let locationsData = [];

    async function loadAllData() {
      try {
        console.log("Chargement des donn√©es du calendrier...");
        const response = await fetch('/calendar/data');
        
        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        stockData = data.stock;
        locationsData = data.locations;
        
        console.log("Donn√©es charg√©es:", { 
          stock: stockData.length, 
          locations: locationsData.length 
        });
        
        initializeCalendar();
        populateItemFilter();
        refreshCalendar();
        updateDetailedPlanning();
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
        // Afficher un message d'erreur √† l'utilisateur
        document.getElementById('calendar').innerHTML = 
          '<div class="error-message">‚ùå Erreur de chargement des donn√©es. Veuillez vous reconnecter.</div>';
      }
    }

    function populateItemFilter() {
      const filter = document.getElementById('itemFilter');
      const options = stockData.map(item => 
        `<option value="${item.id}">${item.name}</option>`
      ).join('');
      filter.innerHTML = '<option value="">Tous les articles</option>' + options;
    }

    function initializeCalendar() {
      const calendarEl = document.getElementById('calendar');
      
      globalCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        headerToolbar: {
          left: 'prev,next,today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: [],
        eventClick: function(info) {
          showEventDetails(info.event);
        },
        height: 'auto',
        eventDisplay: 'block',
        dayMaxEvents: 3,
        moreLinkClick: 'popover'
      });
      
      globalCalendar.render();
    }

    function refreshCalendar() {
      if (!globalCalendar) return;

      const itemFilter = document.getElementById('itemFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      let filteredLocations = locationsData;
      
      if (itemFilter) {
        filteredLocations = filteredLocations.filter(loc => loc.itemId.toString() === itemFilter);
      }
      
      if (statusFilter) {
        filteredLocations = filteredLocations.filter(location => {
          switch (statusFilter) {
            case 'upcoming':
              return ['planned', 'pending'].includes(location.status);
            case 'active':
              return location.status === 'ongoing';
            case 'past':
              return location.status === 'finished';
            default:
              return true;
          }
        });
      }

      const events = filteredLocations.map(location => {
        const item = stockData.find(s => s.id === location.itemId);
        const itemName = item ? item.name : `Article ${location.itemId}`;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const fromDate = new Date(location.from);
        const toDate = new Date(location.to);
        
        // Utiliser le statut r√©el de la location plut√¥t que juste les dates
        let className = 'past';
        let displayTitle = `${location.clientName || location.customerName || 'Client'} - ${itemName}`;
        
        switch (location.status) {
          case 'planned':
          case 'pending':
            className = 'upcoming';
            displayTitle = `[Planifi√©] ${displayTitle}`;
            break;
          case 'ongoing':
            className = 'active';
            displayTitle = `[En cours] ${displayTitle}`;
            break;
          case 'finished':
            className = 'past';
            displayTitle = `[Termin√©] ${displayTitle}`;
            break;
          default:
            // Fallback sur les dates si le statut n'est pas d√©fini
            if (fromDate > today) {
              className = 'upcoming';
            } else if (toDate >= today) {
              className = 'active';
            }
        }

        return {
          id: location.id,
          title: displayTitle,
          start: location.from,
          end: getNextDay(location.to), // FullCalendar attend la date de fin + 1 jour pour les √©v√©nements "all day"
          className: `event-${className}`,
          extendedProps: {
            location: location,
            item: item
          }
        };
      });

      globalCalendar.removeAllEvents();
      globalCalendar.addEventSource(events);
    }

    function getNextDay(dateStr) {
      const date = new Date(dateStr);
      date.setDate(date.getDate() + 1);
      return date.toISOString().split('T')[0];
    }

    function showEventDetails(event) {
      const location = event.extendedProps.location;
      const item = event.extendedProps.item;
      
      const days = Math.ceil((new Date(location.to) - new Date(location.from)) / (1000 * 60 * 60 * 24)) + 1;
      const price = item ? item.price || 0 : 0;
      const total = price * (location.qty || 1) * days + (location.deliveryCost || 0);

      const detailsHTML = `
        <h3>D√©tails de la r√©servation</h3>
        <div class="event-details">
          <div class="detail-section">
            <h4>Statut</h4>
            <p><strong class="status-${location.status}">${getStatusLabel(location.status)}</strong></p>
          </div>
          
          <div class="detail-section">
            <h4>Client</h4>
            <p><strong>${location.clientName || location.customerName || 'Client inconnu'}</strong></p>
            ${location.contactPhone || location.customerPhone ? `<p>üìû ${location.contactPhone || location.customerPhone}</p>` : ''}
            ${location.contactEmail || location.customerEmail ? `<p>‚úâÔ∏è ${location.contactEmail || location.customerEmail}</p>` : ''}
            ${location.messengerHandle ? `<p>üí¨ ${location.messengerHandle}</p>` : ''}
            ${location.preferredContact ? `<p><small>Contact pr√©f√©r√©: ${location.preferredContact}</small></p>` : ''}
          </div>
          
          <div class="detail-section">
            <h4>Mat√©riel</h4>
            <p><strong>${item ? item.name : `Article ${location.itemId}`}</strong></p>
            <p>Quantit√©: ${location.qty || 1}</p>
            ${item ? `<p>Prix: ${item.price || 0}‚Ç¨/jour</p>` : ''}
            ${item ? `<p>Caution: ${item.caution || 0}‚Ç¨</p>` : ''}
          </div>
          
          <div class="detail-section">
            <h4>Dates et co√ªts</h4>
            <p><strong>Du:</strong> ${location.from}</p>
            <p><strong>Au:</strong> ${location.to}</p>
            <p><strong>Dur√©e:</strong> ${days} jour(s)</p>
            <p><strong>Total:</strong> ${total.toFixed(2)}‚Ç¨</p>
            ${location.deliveryCost ? `<p><strong>Livraison:</strong> ${location.deliveryCost}‚Ç¨</p>` : ''}
          </div>
          
          ${location.requestComment || location.comments ? `
            <div class="detail-section">
              <h4>Commentaires</h4>
              <p>${location.requestComment || location.comments}</p>
            </div>
          ` : ''}
          
          ${location.deliveryAddress || location.customerAddress ? `
            <div class="detail-section">
              <h4>Adresse</h4>
              <p>${location.deliveryAddress || location.customerAddress}</p>
            </div>
          ` : ''}
        </div>
        
        <div class="modal-actions">
          ${location.status === 'planned' ? `<button onclick="startLocationFromCalendar(${location.id})" class="btn-success">D√©marrer</button>` : ''}
          ${location.status === 'ongoing' ? `<button onclick="finishLocationFromCalendar(${location.id})" class="btn-warning">Terminer</button>` : ''}
          <button onclick="editLocationFromCalendar(${location.id})" class="btn-primary">Modifier</button>
          <button onclick="deleteLocationFromCalendar(${location.id})" class="btn-delete">Supprimer</button>
        </div>
      `;

      document.getElementById('eventDetails').innerHTML = detailsHTML;
      document.getElementById('eventModal').style.display = 'block';
    }

    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    function getStatusLabel(status) {
      switch (status) {
        case 'planned': return 'üìÖ Planifi√©';
        case 'pending': return '‚è≥ En attente';
        case 'ongoing': return 'üîÑ En cours';
        case 'finished': return '‚úÖ Termin√©';
        default: return status || 'Inconnu';
      }
    }

    async function startLocationFromCalendar(locationId) {
      if (!confirm('D√©marrer cette r√©servation ?')) return;

      try {
        const response = await fetch(`/locations/${locationId}/start`, { method: 'PUT' });
        if (response.ok) {
          closeEventModal();
          loadAllData();
        } else {
          alert('Erreur lors du d√©marrage de la r√©servation');
        }
      } catch (error) {
        console.error('Erreur lors du d√©marrage:', error);
        alert('Erreur lors du d√©marrage de la r√©servation');
      }
    }

    async function finishLocationFromCalendar(locationId) {
      if (!confirm('Terminer cette r√©servation ?')) return;

      try {
        const response = await fetch(`/locations/${locationId}/finish`, { method: 'PUT' });
        if (response.ok) {
          closeEventModal();
          loadAllData();
        } else {
          alert('Erreur lors de la finalisation de la r√©servation');
        }
      } catch (error) {
        console.error('Erreur lors de la finalisation:', error);
        alert('Erreur lors de la finalisation de la r√©servation');
      }
    }

    function editLocationFromCalendar(locationId) {
      closeEventModal();
      window.location.href = `locations.html?edit=${locationId}`;
    }

    async function deleteLocationFromCalendar(locationId) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©servation ?')) return;

      try {
        const response = await fetch(`/locations/${locationId}`, { method: 'DELETE' });
        if (response.ok) {
          closeEventModal();
          loadAllData();
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
      }
    }

    function updateDetailedPlanning() {
      const container = document.getElementById('detailedPlanning');
      
      if (locationsData.length === 0) {
        container.innerHTML = '<p>Aucune r√©servation</p>';
        return;
      }

      // Grouper par semaine
      const weeklyPlanning = {};
      
      locationsData.forEach(location => {
        const startDate = new Date(location.from);
        const weekStart = getWeekStart(startDate);
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeklyPlanning[weekKey]) {
          weeklyPlanning[weekKey] = [];
        }
        
        weeklyPlanning[weekKey].push(location);
      });

      let planningHTML = '';
      
      Object.keys(weeklyPlanning)
        .sort()
        .slice(0, 4) // Afficher seulement les 4 prochaines semaines
        .forEach(weekKey => {
          const weekStart = new Date(weekKey);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          planningHTML += `
            <div class="week-section">
              <h4>Semaine du ${formatDate(weekStart)} au ${formatDate(weekEnd)}</h4>
              <div class="week-locations">
          `;
          
          weeklyPlanning[weekKey]
            .sort((a, b) => new Date(a.from) - new Date(b.from))
            .forEach(location => {
              const item = stockData.find(s => s.id === location.itemId);
              const itemName = item ? item.name : `Article ${location.itemId}`;
              
              planningHTML += `
                <div class="planning-item">
                  <div class="planning-date">${location.from} ‚Üí ${location.to}</div>
                  <div class="planning-client"><strong>${location.clientName}</strong></div>
                  <div class="planning-item-name">${itemName} (${location.qty || 1})</div>
                  ${location.eventDescription ? `<div class="planning-event">${location.eventDescription}</div>` : ''}
                </div>
              `;
            });
          
          planningHTML += `
              </div>
            </div>
          `;
        });

      container.innerHTML = planningHTML;
    }

    function getWeekStart(date) {
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Ajuster pour que lundi soit le premier jour
      return new Date(date.setDate(diff));
    }

    function formatDate(date) {
      return date.toLocaleDateString('fr-FR', { 
        day: 'numeric', 
        month: 'short' 
      });
    }

    // Event listeners pour les filtres
    document.getElementById('itemFilter').addEventListener('change', refreshCalendar);
    document.getElementById('statusFilter').addEventListener('change', refreshCalendar);

    // Fermer les modales en cliquant √† l'ext√©rieur
    window.onclick = function(event) {
      const modal = document.getElementById('eventModal');
      if (event.target == modal) {
        closeEventModal();
      }
    }

    // Initialize calendar when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM Content Loaded !");
      
      // Initialize calendar AFTER everything else is loaded
      setTimeout(() => {
        try {
          console.log("Initialisation du calendrier...");
          const calendarEl = document.getElementById('calendar');
          if (!calendarEl) {
            console.error("√âl√©ment calendar non trouv√© !");
            return;
          }

          if (typeof FullCalendar === 'undefined') {
            console.error("FullCalendar non charg√© !");
            return;
          }
          
          // Charger les donn√©es AVANT d'initialiser le calendrier
          loadAllData();
          console.log("Calendrier initialis√© avec succ√®s !");
        } catch (error) {
          console.error("Erreur lors de l'initialisation du calendrier:", error);
        }
      }, 100);
    });
  </script>
</body>
</html>